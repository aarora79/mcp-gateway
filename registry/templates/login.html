<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Enhanced cache prevention headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, private">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Prevent storing browsing history -->
    <meta http-equiv="Clear-Site-Data" content="'cookies', 'storage'">
    <title>Login - MCP Gateway</title>
    <!-- Add timestamp to CSS URL to ensure fresh loading -->
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}?v={{ timestamp|default('1') }}">
    <!-- Add a script to clear any stored OAuth tokens -->
    <script type="text/javascript">
        // Function to clear ALL browser storage
        function clearAllStorage() {
            console.log("Performing complete browser storage cleanup");
            
            try {
                // Clear localStorage and sessionStorage completely
                localStorage.clear();
                sessionStorage.clear();
                console.log("Browser storage cleared");
                
                // Clear any AWS Cognito/Amplify tokens if they exist
                if (window.AWS && window.AWS.config && window.AWS.config.credentials) {
                    window.AWS.config.credentials.clearCachedId();
                    console.log("AWS credentials cleared");
                }
                
                // Clear all cookies with multiple domain and path combinations to be thorough
                const domains = ['', window.location.hostname, '.' + window.location.hostname];
                const paths = ['/', '/oauth', '/api', ''];
                
                domains.forEach(domain => {
                    paths.forEach(path => {
                        document.cookie.split(";").forEach(function(c) {
                            const cookie = c.trim();
                            const eqPos = cookie.indexOf("=");
                            const name = eqPos > -1 ? cookie.substring(0, eqPos) : cookie;
                            if (name) {
                                // Set expiration in the past with various domain/path combinations
                                document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=${path}${domain ? `;domain=${domain}` : ''}`;
                            }
                        });
                    });
                });
                console.log("Cookies cleared with multiple domain/path combinations");
                
                // Attempt to clear specific authentication tokens by name
                const storageItems = [
                    // Common OAuth 2.0 token names
                    'id_token', 'access_token', 'refresh_token', 'token_type', 'expires_in', 'expires_at',
                    // OIDC specific
                    'oidc.user', 'auth.state', 'auth.nonce', 'auth.code_verifier',
                    // Cognito specific
                    'CognitoIdentityServiceProvider', 'aws.cognito.identity-id', 'amplify-signin-with-hostedUI',
                    // Session related
                    'mcp_gateway_session', 'session', 'user', 'auth'
                ];
                
                storageItems.forEach(item => {
                    localStorage.removeItem(item);
                    sessionStorage.removeItem(item);
                    
                    // Try to clear cognito specific items with wildcards
                    if (item === 'CognitoIdentityServiceProvider') {
                        // Find and clear all cognito related items
                        Object.keys(localStorage).forEach(key => {
                            if (key.includes('CognitoIdentityServiceProvider')) {
                                localStorage.removeItem(key);
                            }
                        });
                        Object.keys(sessionStorage).forEach(key => {
                            if (key.includes('CognitoIdentityServiceProvider')) {
                                sessionStorage.removeItem(key);
                            }
                        });
                    }
                });
                console.log("Authentication tokens cleared");
                
                // Try to clear cache if browser supports it
                if (window.caches && window.caches.keys) {
                    window.caches.keys().then(cacheNames => {
                        cacheNames.forEach(cacheName => {
                            window.caches.delete(cacheName);
                        });
                    });
                    console.log("Browser cache API cleared");
                }
                
            } catch (e) {
                console.error("Error during storage clearing:", e);
            }
        }

        // Run on page load
        window.onload = function() {
            // Check URL for signed_out parameter
            const urlParams = new URLSearchParams(window.location.search);
            const isSignedOut = urlParams.get('signed_out');
            
            // If signed_out=true, do a complete cleanup
            if (isSignedOut === 'true') {
                console.log("User signed out, performing complete cleanup");
                clearAllStorage();
                
                // Force page reload after a short delay if we have cookies
                // This helps with stubborn cookies that might not be cleared properly
                if (document.cookie) {
                    console.log("Still have cookies after cleanup, will force reload");
                    setTimeout(function() {
                        // Remove signed_out parameter to avoid infinite reload loop
                        urlParams.delete('signed_out');
                        let newUrl = window.location.pathname;
                        if (urlParams.toString()) {
                            newUrl += '?' + urlParams.toString();
                        }
                        window.location.href = newUrl; // Hard reload
                    }, 100);
                } else {
                    // Remove the signed_out parameter from URL to prevent re-clearing on refresh
                    urlParams.delete('signed_out');
                    let newUrl = window.location.pathname;
                    if (urlParams.toString()) {
                        newUrl += '?' + urlParams.toString();
                    }
                    
                    // Replace the URL without reloading the page
                    window.history.replaceState({}, document.title, newUrl);
                }
            } else {
                // Always do a basic cleanup on login page to be safe
                clearAllStorage();
            }
            
            // Add a beforeunload listener to try one last cookie clear before page navigations
            window.addEventListener('beforeunload', function() {
                // Quick final cookie clear attempt
                try {
                    document.cookie.split(";").forEach(function(c) {
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                    });
                } catch(e) {}
            });
        };
    </script>
</head>
<body class="login-body">

    <div class="login-container">
        <div class="login-header">
             <img src="{{ url_for('static', path='/logo.png') }}" alt="MCP Gateway Logo" height="40" style="margin-bottom: 15px;">
            <h2>Admin Login</h2>
        </div>

        {% if error %}
        <p class="error-message">{{ error }}</p>
        {% endif %}

        {% if oauth_enabled %}
        <!-- OAuth login only when enabled - include timestamp to prevent caching -->
        <a href="/oauth/login?t={{ timestamp|default('1') }}" class="btn-oauth 
            {% if provider_type == 'cognito' %}btn-cognito{% endif %}
            {% if provider_type == 'okta' %}btn-okta{% endif %}
            {% if provider_type == 'azure' %}btn-azure{% endif %}
            {% if provider_type == 'google' %}btn-google{% endif %}
            {% if provider_type == 'auth0' %}btn-auth0{% endif %}
        ">
            Sign in with {{ provider_type|title if provider_type else 'OAuth' }}
        </a>
        {% else %}
        <!-- Standard form login only when OAuth is not enabled -->
        <form action="/login" method="post">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required placeholder="Enter username">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required placeholder="Enter password">
            </div>
            <button type="submit">Login</button>
        </form>
        {% endif %}
    </div>

    <style>
        .btn-oauth {
            display: block;
            padding: 15px 25px;
            margin: 20px auto 0;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s;
            max-width: 300px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .btn-oauth:hover {
            background-color: #555;
            box-shadow: 0 3px 7px rgba(0,0,0,0.3);
        }
        
        .btn-cognito {
            background-color: #ff9900;
        }
        
        .btn-cognito:hover {
            background-color: #e68a00;
        }
        
        .btn-okta {
            background-color: #007dc1;
        }
        
        .btn-okta:hover {
            background-color: #006ba7;
        }
        
        .btn-azure {
            background-color: #0072c6;
        }
        
        .btn-azure:hover {
            background-color: #005da3;
        }
        
        .btn-google {
            background-color: #4285F4;
        }
        
        .btn-google:hover {
            background-color: #2a75f3;
        }
        
        .btn-auth0 {
            background-color: #eb5424;
        }
        
        .btn-auth0:hover {
            background-color: #d44a1e;
        }
    </style>
</body>
</html>